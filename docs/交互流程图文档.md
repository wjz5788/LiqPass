# LiqPass 交互流程图文档

## 📋 文档概述

本文档使用Mermaid图表详细描述了LiqPass项目中各组件之间的交互流程，包括系统架构、API调用、业务流程等完整的交互关系。

## 🏗️ 系统架构交互图

### 1. 整体系统架构

```mermaid
graph TB
    subgraph "前端层"
        F[前端应用<br/>React + TypeScript<br/>Port: 5173]
    end
    
    subgraph "后端服务层"
        B[美国后端服务器<br/>Node.js + Express<br/>Port: 8080]
        J[日本验证服务器<br/>Node.js + Express<br/>Port: 8787]
    end
    
    subgraph "数据层"
        DB[(SQLite数据库<br/>订单/理赔数据)]
        BC[(区块链网络<br/>Base链)]
    end
    
    subgraph "外部服务"
        EX1[交易所API<br/>Binance/OKX]
        EX2[智能合约<br/>LeverageGuard]
    end
    
    F -->|HTTP API| B
    B -->|HTTP API| J
    B -->|数据库操作| DB
    B -->|区块链交互| BC
    J -->|交易所API| EX1
    BC -->|合约调用| EX2
    
    style F fill:#e1f5fe
    style B fill:#f3e5f5
    style J fill:#f3e5f5
    style DB fill:#e8f5e8
    style BC fill:#e8f5e8
    style EX1 fill:#fff3e0
    style EX2 fill:#fff3e0
```

### 2. 网络通信架构

```mermaid
graph LR
    subgraph "用户端"
        U[用户浏览器]
    end
    
    subgraph "应用层"
        F[前端应用<br/>localhost:5173]
    end
    
    subgraph "API网关层"
        B[美国后端<br/>localhost:8080]
    end
    
    subgraph "验证服务层"
        J[日本验证<br/>localhost:8787]
    end
    
    subgraph "区块链层"
        C[智能合约<br/>Base链]
    end
    
    U -->|HTTP| F
    F -->|/api/verify/*| B
    B -->|HTTP| J
    B -->|JSON-RPC| C
    
    style U fill:#e1f5fe
    style F fill:#f3e5f5
    style B fill:#bbdefb
    style J fill:#c8e6c9
    style C fill:#fff9c4
```

## 🔌 API调用交互图

### 1. 订单创建完整流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端应用
    participant B as 美国后端
    participant J as 日本验证
    participant DB as 数据库
    participant EX as 交易所API
    
    Note over U,F: 1. 用户选择产品
    U->>F: 选择保险产品并填写订单信息
    
    Note over F,B: 2. 前端提交订单
    F->>B: POST /orders<br/>Idempotency-Key: order-123
    
    Note over B,DB: 3. 幂等性检查
    B->>DB: 检查幂等键是否存在
    alt 幂等记录存在
        DB->>B: 返回缓存响应
        B->>F: 返回缓存结果
    else 新请求
        Note over B,J: 4. 订单验证
        B->>J: POST /verify/order<br/>交易所订单验证
        J->>EX: 调用交易所API验证订单
        EX->>J: 返回订单验证结果
        J->>B: 返回验证响应
        
        alt 验证成功
            Note over B,DB: 5. 保存订单
            B->>DB: 创建新订单记录
            DB->>B: 返回订单ID
            B->>F: 返回订单创建成功
        else 验证失败
            B->>F: 返回验证失败错误
        end
    end
    
    Note over F,U: 6. 显示结果
    F->>U: 显示订单创建结果
```

### 2. 理赔申请流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端应用
    participant B as 美国后端
    participant DB as 数据库
    participant C as 智能合约
    participant BC as 区块链
    
    Note over U,F: 1. 用户提交理赔
    U->>F: 填写理赔申请信息<br/>上传爆仓证据
    
    Note over F,B: 2. 前端提交理赔
    F->>B: POST /claim<br/>Idempotency-Key: claim-456
    
    Note over B,DB: 3. 验证订单状态
    B->>DB: 查询订单是否存在且状态为liquidated
    alt 订单无效
        B->>F: 返回订单无效错误
    else 订单有效
        Note over B,DB: 4. 创建理赔记录
        B->>DB: 创建理赔申请记录
        DB->>B: 返回理赔ID
        B->>F: 返回理赔接收成功
    end
    
    Note over F,U: 5. 用户确认
    F->>U: 显示理赔提交成功
    
    Note over B,C: 6. 管理员赔付（异步）
    B->>DB: 查询待赔付理赔
    B->>C: 调用payout函数<br/>recipient, amount, claimId
    C->>BC: 执行USDC转账交易
    BC->>C: 返回交易哈希
    C->>B: 返回赔付结果
    B->>DB: 更新理赔状态为paid
```

### 3. 健康检查流程

```mermaid
sequenceDiagram
    participant M as 监控系统
    participant B as 美国后端
    participant J as 日本验证
    participant DB as 数据库
    participant BC as 区块链
    
    Note over M,B: 1. 后端健康检查
    M->>B: GET /health
    B->>DB: 检查数据库连接
    DB->>B: 连接正常
    B->>BC: 检查区块链连接
    BC->>B: 连接正常
    B->>M: 返回健康状态
    
    Note over M,J: 2. 验证服务健康检查
    M->>J: GET /health
    J->>M: 返回健康状态
    
    Note over M: 3. 汇总健康状态
    M->>M: 评估整体系统健康度
```

## 📊 数据流交互图

### 1. 订单数据流

```mermaid
flowchart TD
    A[用户输入订单信息] --> B{前端验证}
    B -->|验证通过| C[生成幂等键]
    B -->|验证失败| D[显示错误信息]
    
    C --> E[发送创建订单请求]
    E --> F{后端幂等检查}
    F -->|已存在| G[返回缓存响应]
    F -->|新请求| H[调用日本验证]
    
    H --> I{订单验证结果}
    I -->|验证成功| J[保存订单数据]
    I -->|验证失败| K[返回验证错误]
    
    J --> L[返回订单创建成功]
    L --> M[更新前端状态]
    
    style A fill:#e1f5fe
    style B fill:#fff3e0
    style J fill:#c8e6c9
    style K fill:#ffcdd2
```

### 2. 理赔数据流

```mermaid
flowchart LR
    A[交易爆仓事件] --> B[用户发现爆仓]
    B --> C[收集爆仓证据]
    C --> D[提交理赔申请]
    D --> E{订单有效性检查}
    
    E -->|有效| F[创建理赔记录]
    E -->|无效| G[拒绝理赔申请]
    
    F --> H[等待管理员审核]
    H --> I{审核结果}
    I -->|批准| J[执行链上赔付]
    I -->|拒绝| K[通知用户拒绝]
    
    J --> L[更新理赔状态]
    L --> M[用户收到赔付]
    
    style A fill:#ffcdd2
    style J fill:#c8e6c9
    style M fill:#e1f5fe
```

## 🔄 状态机交互图

### 1. 订单状态机

```mermaid
stateDiagram-v2
    [*] --> Pending : 创建订单
    Pending --> Verifying : 开始验证
    Verifying --> Active : 验证成功
    Verifying --> Rejected : 验证失败
    
    Active --> Expired : 保险期满
    Active --> Liquidated : 交易爆仓
    
    Liquidated --> Claimed : 提交理赔
    Claimed --> Paid : 赔付完成
    
    Expired --> [*] : 订单结束
    Rejected --> [*] : 订单结束
    Paid --> [*] : 订单结束
    
    note right of Pending
        订单创建成功
        等待验证
    end note
    
    note right of Active
        保险生效中
        监控交易状态
    end note
    
    note right of Paid
        赔付已完成
        订单流程结束
    end note
```

### 2. 理赔状态机

```mermaid
stateDiagram-v2
    [*] --> Received : 提交理赔
    Received --> Reviewing : 开始审核
    Reviewing --> Approved : 审核通过
    Reviewing --> Rejected : 审核拒绝
    
    Approved --> Paying : 开始赔付
    Paying --> Paid : 赔付完成
    
    Rejected --> [*] : 理赔结束
    Paid --> [*] : 理赔结束
    
    note right of Received
        理赔申请已接收
        等待人工审核
    end note
    
    note right of Approved
        理赔申请已批准
        准备执行赔付
    end note
    
    note right of Paid
        赔付已完成
        理赔流程结束
    end note
```

## 🏦 资金流交互图

### 1. 保费资金流

```mermaid
flowchart TB
    A[用户支付保费] --> B[前端确认支付]
    B --> C[记录保费收入]
    C --> D[更新资金池余额]
    D --> E[保险合约生效]
    
    style A fill:#c8e6c9
    style E fill:#bbdefb
```

### 2. 赔付资金流

```mermaid
flowchart TB
    A[理赔批准] --> B[检查资金池]
    B --> C{资金是否充足?}
    C -->|是| D[执行链上转账]
    C -->|否| E[资金池预警]
    
    D --> F[更新赔付记录]
    F --> G[通知用户收款]
    
    E --> H[等待资金补充]
    H --> D
    
    style A fill:#ffcdd2
    style G fill:#c8e6c9
```

## 🔒 安全交互图

### 1. 身份验证流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端
    participant W as 钱包
    
    U->>F: 请求连接钱包
    F->>W: 发起钱包连接
    W->>U: 请求授权
    U->>W: 确认授权
    W->>F: 返回钱包地址
    F->>B: 验证钱包签名
    B->>F: 返回验证结果
    F->>U: 显示登录状态
```

### 2. API安全调用流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as API网关
    participant S as 业务服务
    participant A as 认证服务
    
    C->>G: 请求API (带Token)
    G->>A: 验证Token有效性
    A->>G: 返回验证结果
    
    alt Token有效
        G->>S: 转发请求
        S->>G: 返回业务数据
        G->>C: 返回成功响应
    else Token无效
        G->>C: 返回401错误
    end
```

## 📈 监控交互图

### 1. 系统监控流程

```mermaid
flowchart LR
    A[监控代理] --> B[收集指标数据]
    B --> C[聚合分析]
    C --> D{是否异常?}
    D -->|是| E[触发告警]
    D -->|否| F[记录指标]
    E --> G[通知运维团队]
    F --> H[生成监控报告]
    
    style A fill:#fff3e0
    style E fill:#ffcdd2
    style H fill:#c8e6c9
```

### 2. 业务监控流程

```mermaid
flowchart TD
    A[业务事件] --> B[事件采集]
    B --> C[实时分析]
    C --> D{业务规则检查}
    D -->|合规| E[正常处理]
    D -->|异常| F[风险预警]
    E --> G[更新业务状态]
    F --> H[人工干预]
    
    style A fill:#e1f5fe
    style F fill:#ffcdd2
    style G fill:#c8e6c9
```

## 🔄 错误处理交互图

### 1. API错误处理流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant B as 后端
    participant L as 日志系统
    participant M as 监控系统
    
    C->>B: 发送API请求
    
    alt 请求成功
        B->>C: 返回成功响应
    else 业务错误
        B->>L: 记录业务错误日志
        B->>C: 返回业务错误响应
    else 系统错误
        B->>L: 记录系统错误日志
        B->>M: 上报系统错误指标
        B->>C: 返回系统错误响应
    else 网络超时
        B->>L: 记录超时日志
        B->>M: 上报超时指标
        B->>C: 返回超时错误
    end
```

### 2. 重试机制流程

```mermaid
flowchart LR
    A[发起请求] --> B{请求成功?}
    B -->|是| C[处理响应]
    B -->|否| D[检查重试次数]
    D --> E{可重试?}
    E -->|是| F[等待重试间隔]
    F --> A
    E -->|否| G[最终失败处理]
    
    style A fill:#e1f5fe
    style C fill:#c8e6c9
    style G fill:#ffcdd2
```

## 📋 总结

本文档通过Mermaid图表详细展示了LiqPass项目的各种交互流程，包括：

1. **系统架构交互**: 展示各组件之间的通信关系
2. **API调用流程**: 详细描述接口调用顺序和数据流转
3. **数据流交互**: 展示业务数据的处理流程
4. **状态机交互**: 描述业务状态的变化逻辑
5. **资金流交互**: 展示资金流动的安全流程
6. **安全交互**: 描述身份验证和安全调用机制
7. **监控交互**: 展示系统监控和业务监控流程
8. **错误处理**: 描述异常情况的处理机制

这些交互流程图为开发人员、测试人员和运维人员提供了清晰的系统理解，有助于快速定位问题、优化性能和确保系统稳定性。